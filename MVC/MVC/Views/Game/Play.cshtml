@model MVC.Models.Game
@Html.AntiForgeryToken()

<div class="d-flex justify-content-center" style="margin-top: 20px;">
    <h2>Playing against <span style="font-weight: bold; color: #007bff;">@Model.Opponent</span></h2>
</div>

<div class="d-flex justify-content-center" style="margin-top: 10px;">
    <p>
        <strong>Your Color:</strong>
        <span class="player-color-indicator"
              style="background-color: @(Model.Color == Color.White ? "#FFFFFF" : "#000000");
                     color: @(Model.Color == Color.White ? "#000000" : "#FFFFFF");
                     padding: 5px 10px;
                     border-radius: 5px;
                     border: 1px solid #ddd;
                     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                     display: inline-block;">
            @Model.Color
        </span>
    </p>
</div>

<div id="players-turn-container" class="d-flex justify-content-center" style="margin-top: 10px;">
    <div class="d-flex justify-content-center" style="margin-top: 10px;">
        <p>
            <strong>Player's turn':</strong>
            <span class="player-color-indicator"
                  style="background-color: @(Model.Partial.PlayersTurn == Color.White ? "#FFFFFF" : "#000000");
                     color: @(Model.Partial.PlayersTurn == Color.White ? "#000000" : "#FFFFFF");
                     padding: 5px 10px;
                     border-radius: 5px;
                     border: 1px solid #ddd;
                     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                     display: inline-block;">
                @Model.Partial.PlayersTurn
            </span>
        </p>
    </div>
</div>

<div id="timer-container" class="d-flex justify-content-center" style="margin-top: 10px;">
    <div class="d-flex justify-content-center" style="margin-top: 10px;">
        <p>
            <span class="player-color-indicator"
                  style="background-color: @(Model.Partial.PlayersTurn == Color.White ? "#FFFFFF" : "#000000");
                     color: @(Model.Partial.PlayersTurn == Color.White ? "#000000" : "#FFFFFF");
                     padding: 5px 10px;
                     border-radius: 5px;
                     border: 1px solid #ddd;
                     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                     display: inline-block;">
                @Model.Partial.Time sec
            </span>
        </p>
    </div>
</div>

@if (Model.Color == Color.White)
{
    <div class="d-flex justify-content-center" style="margin-top: 10px; gap: 20px;">
        <p>
            <span class="player-color-indicator"
                  style="background-color: @(Model.Color == Color.White ? "#FFFFFF" : "#000000");
                     color: @(Model.Color == Color.White ? "#000000" : "#FFFFFF");
                     padding: 5px 10px;
                     border-radius: 5px;
                     border: 1px solid #ddd;
                     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                     display: inline-block;">
                <strong><span id="player-score">0</span></strong>
            </span>
        </p>
        <p>
            <span class="player-color-indicator"
                  style="background-color: @(Model.Color == Color.White ? "#000000" : "#FFFFFF");
                     color: @(Model.Color == Color.White ? "#FFFFFF" : "#000000");
                     padding: 5px 10px;
                     border-radius: 5px;
                     border: 1px solid #ddd;
                     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                     display: inline-block;">
                <strong><span id="opponent-score">0</span></strong>
            </span>
        </p>
    </div>
}
else
{
    <div class="d-flex justify-content-center" style="margin-top: 10px; gap: 20px;">
        <p>
            <span class="player-color-indicator"
                  style="background-color: @(Model.Color == Color.White ? "#000000" : "#FFFFFF");
                     color: @(Model.Color == Color.White ? "#FFFFFF" : "#000000");
                     padding: 5px 10px;
                     border-radius: 5px;
                     border: 1px solid #ddd;
                     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                     display: inline-block;">
                <strong><span id="player-score">0</span></strong>
            </span>
        </p>
        <p>
            <span class="player-color-indicator"
                  style="background-color: @(Model.Color == Color.White ? "#FFFFFF" : "#000000");
                     color: @(Model.Color == Color.White ? "#000000" : "#FFFFFF");
                     padding: 5px 10px;
                     border-radius: 5px;
                     border: 1px solid #ddd;
                     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                     display: inline-block;">
                <strong><span id="opponent-score">0</span></strong>
            </span>
        </p>
    </div>
}

<div id="board-container" class="d-flex justify-content-center">
    <table class="table table-bordered" style="width: auto;">
        @for (int row = 0; row < Model?.Partial.Board.GetLength(0); row++)
        {
            <tr>
                @for (int col = 0; col < Model.Partial.Board.GetLength(1); col++)
                {
                    var cell = Model.Partial.Board[row, col];
                    var cellDisplay = cell == Color.None ? "" : cell.ToString();
                    var pieceClass = cell == Color.White ? "player-piece" : cell == Color.Black ? "opponent-piece" : "";
                    <td style="width: 50px; height: 50px; text-align: center; background-color:@((row + col) % 2 == 0 ? "lawngreen" : "limegreen");"
                        data-row="@row"
                        data-col="@col"
                        onclick="cellClicked(this)">
                        @if (cell == Color.None)
                        {
                            <i></i>
                        }
                        else
                        {
                            <i class="fa fa-circle @pieceClass" style="font-size: 30px; color: @(cell.ToString());"></i>
                        }
                    </td>
                }
            </tr>
        }
    </table>
    <div id="game-status" data-status="@Model?.Partial.InGame"></div>
</div>

<div class="d-flex justify-content-center">
    <div style="display: flex; flex-direction: column; align-items: center;">
        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn btn-primary" onclick="passGame()">Pass</button>
            <button type="button" class="btn btn-danger" onclick="forfeitGame()">Forfeit</button>
        </div>
    </div>
</div>

<script>
    let cellSelected = null;

    function cellClicked(cell) {
        const row = cell.getAttribute('data-row');
        const col = cell.getAttribute('data-col');

        cellSelected = {
            row: parseInt(row),
            col: parseInt(col),
            element: cell
        };
        cell.style.border = '2px solid red';

        sendMove(cellSelected.row, cellSelected.col);
        selectedCell = null;
    }

    function sendMove(row, col) {
        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

        const moveData = {
            Row: row,
            Column: col
        };

        fetch('@Url.Action("Move", "Game")', {
            method: 'POST',
            headers: {
                'RequestVerificationToken': antiForgeryToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(moveData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    refreshContainers();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function passGame() {
        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

        fetch('@Url.Action("Pass", "Game")', {
            method: 'POST',
            headers: {
                'RequestVerificationToken': antiForgeryToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.ok) {
                    refreshContainers();
                } else {
                    alert('Unable to pass');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function forfeitGame() {
        const playersTurnIndicator = document.querySelector("#players-turn-container .player-color-indicator");
        const isPlayersTurn = playersTurnIndicator && playersTurnIndicator.textContent.trim() === "@Model?.Color";

        if (!isPlayersTurn) {
            alert("You can only forfeit on your turn.");
            return;
        }

        if (!confirm("Are you sure you want to forfeit the game?")) {
            return;
        }

        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

        fetch('@Url.Action("Forfeit", "Game")', {
            method: 'POST',
            headers: {
                'RequestVerificationToken': antiForgeryToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = '@Url.Action("Result", "Home")';
                } else {
                    alert('Unable to forfeit');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function calculateScores() {
        let playerScore = 0;
        let opponentScore = 0;

        const boardCells = document.querySelectorAll("#board-container td");

        boardCells.forEach(cell => {
            const piece = cell.querySelector("i");

            if (piece) {
                if (piece.classList.contains("player-piece")) {
                    playerScore++;
                } else if (piece.classList.contains("opponent-piece")) {
                    opponentScore++;
                }
            }
        });

        document.getElementById("player-score").textContent = playerScore;
        document.getElementById("opponent-score").textContent = opponentScore;
    }

    function refreshContainers() {
        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

        const playersTurnContainer = document.getElementById("players-turn-container");
        const timerContainer = document.getElementById("timer-container");
        const boardContainer = document.getElementById("board-container");

        fetch('@Url.Action("Partial", "Game")', {
            method: 'POST',
            headers: {
                'RequestVerificationToken': antiForgeryToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.text())
            .then(data => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');

                const gameStatusElement = doc.getElementById("game-status");
                const gameStatus = gameStatusElement ? gameStatusElement.dataset.status : null;

                if (gameStatus === "False") {
                    window.location.href = '@Url.Action("Result", "Home")';
                }

                const playersTurnContent = doc.getElementById("players-turn-container");
                if (playersTurnContent && playersTurnContainer) {
                    playersTurnContainer.innerHTML = playersTurnContent.innerHTML;
                }

                const timerContent = doc.getElementById("timer-container");
                if (timerContent && timerContainer) {
                    timerContainer.innerHTML = timerContent.innerHTML;
                }

                const friendsContent = doc.getElementById("board-container");
                if (friendsContent && boardContainer) {
                    boardContainer.innerHTML = friendsContent.innerHTML;
                    calculateScores();
                }
            })
            .catch(error => console.error('Error:', error));
    }
    setInterval(refreshContainers, 1000);
</script>